<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Quill Editor with Markdown Support</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script type="x-shader/x-vertex" id="vertexshader">
      varying vec2 vUv;
      void main() {
        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
      }
    </script>

  <script type="x-shader/x-fragment" id="fragmentshader">
      uniform sampler2D baseTexture;
      uniform sampler2D bloomTexture;
      varying vec2 vUv;
      void main() {
        gl_FragColor = (texture2D(baseTexture, vUv) + vec4(1.0) * texture2D(bloomTexture, vUv));
      }
    </script>

</head>

<body>
  <div id="databasesModal" class="modal_databases" style="display: none;">
    <div class="modal-content">
      <span id="closeModal" class="popup-close">&times;</span>
      <h2>Databases</h2>
      <button id="createDatabaseButton" class="create-database-button">Create New Database</button>
      <div id="databasesContainer"></div>
    </div>
  </div>
  
  

  <div id="ui-layer"
    style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2000;">
    <!-- Drop indicator -->
    <div id="drop-indicator" class="drop-indicator" style="pointer-events: auto;"></div>

    <!-- Text Modal -->
    <div id="textModal-text3d" class="modal-text3d" style="pointer-events: auto;">
      <div class="modal-content-text3d">
        <span class="close-text3d">&times;</span>
        <h2 id="modalTitle-text3d"></h2>
        <p id="modalText-text3d"></p>
        <textarea id="editText-text3d" rows="10" cols="50"></textarea>
        <button id="sendButton-text3d">Send</button>
      </div>
    </div>

    <!-- Status Container -->
    <div id="status-container" style="pointer-events: auto;"></div>

    <!-- Sidebar -->
    <div class="sidebar" style="pointer-events: auto;">
      <div class="sidebar-icon" id="homeIcon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
        <span class="tooltip">Home</span>
      </div>
      <div class="sidebar-icon" id="search-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <span class="tooltip">Search</span>
      </div>
      <div class="sidebar-icon" id="peer-btn-connect">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        <span class="tooltip">Connect to peers</span>
      </div>
      <div class="sidebar-icon" id="settingsIcon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"></circle>
          <path
            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
          </path>
        </svg>
        <span class="tooltip">Settings</span>
      </div>
      <div id='saved-db-btn' class="sidebar-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
          <polyline points="22,6 12,13 2,6"></polyline>
        </svg>
        <span class="tooltip">Saved Scenes</span>
      </div>

      <div id="fileTreeBtn" class="sidebar-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <path d="M3 3h18a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"></path>
          <path d="M3 7h18"></path>
          <path d="M3 11h18"></path>
          <path d="M3 15h18"></path>
        </svg>
        <span class="tooltip">File directory</span>
      </div>



      <div id="toggleButton" class="sidebar-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" />
          <path d="M15 5l4 4" />
        </svg>
        <span class="tooltip">Chat with your docs</span>
      </div>

    </div>

    <!-- Separate left slideout -->
    <div class="left-slideout" id="leftSlideout">
      <div class="close-arrow">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </div>
      <div id="fileTreeContainer">
        <div class="tree" id="fileTreeTop">
          <div class="mt-5 pl-3">
            <!-- <a href="#">⿻ Add a file into your scene</a> |
            <a href="#">⿻ create quest</a> |
            <a href="#">⿻ create friend</a> <br> <br> -->
            <strong>File Viewer:</strong> Drag and drop files into your tree to see them here
          </div>
        <div class="tree" id="fileTree">

          <div class="tree">
        
          </div>
        </div>

        </div>
      </div>
    </div>
    <div class="modal" style="pointer-events: all !important;">
      <input type="text" class="p2p_peer_input" id="userIdInput" placeholder="Enter your user ID"
        style="pointer-events: all !important;">
      <input type="text" class="p2p_peer_input" id="peerIdInput" placeholder="Enter peer ID to connect"
        style="pointer-events: all !important;">
      <button id="connectButton" style="pointer-events: all !important;  align-items: center;">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="small-icon">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z" />
      </svg> Connect
        <span class="tooltip">Click to connect to the peer</span>
      </button>
      <!-- <div id="connected-peers-container"></div>
      <div id="status"></div> -->
      <div id="connection-container">
        <div id="peer-pills-container"></div>
        <div id="status">
          <div class="status-text">Create a use ID to share</div>
        </div>
      </div>
      
      <!-- New share buttons container with flexbox -->
      <div style="display: flex; gap: 8px; margin-top: 10px;   width: 100%">
        <button id="shareLinkButton" disabled style="pointer-events: all !important; align-items: center; flex: 1;">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="small-icon">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" />
          </svg>
          Share Link
        </button>
        
        <button id="shareQRButton" disabled style="pointer-events: all !important; align-items: center; flex: 1;">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="small-icon">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 3.75 9.375v-4.5ZM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 0 1-1.125-1.125v-4.5ZM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 13.5 9.375v-4.5Z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 6.75h.75v.75h-.75v-.75ZM6.75 16.5h.75v.75h-.75v-.75ZM16.5 6.75h.75v.75h-.75v-.75ZM13.5 13.5h.75v.75h-.75v-.75ZM13.5 19.5h.75v.75h-.75v-.75ZM19.5 13.5h.75v.75h-.75v-.75ZM19.5 19.5h.75v.75h-.75v-.75ZM16.5 16.5h.75v.75h-.75v-.75Z" />
          </svg>
          Share QR
        </button>
      </div>
    </div>

    <div id="popup"></div>
    <div id="overlay" class="overlay" style="display: none;"></div>

    <div class="slideout" id="chatSlideout">
      
      <div class="resize-handle">
        <div class="handle-line"></div>
      </div>
      <div class="slideout-content" id="slideoutContent">
        <!-- Editor content will go here -->
      </div>


      <!-- BUTTONS -->

      <div class="editor-button-group">
        <button class="editor-btn copy-btn" title="Copy content">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75" />
          </svg>
        </button>
        <button class="editor-btn share-btn" title="Share via email">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 1 0 0 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186 9.566-5.314m-9.566 7.5 9.566 5.314m0 0a2.25 2.25 0 1 0 3.935 2.186 2.25 2.25 0 0 0-3.935-2.186Zm0-12.814a2.25 2.25 0 1 0 3.933-2.185 2.25 2.25 0 0 0-3.933 2.185Z" />
          </svg>
        </button>
        <div class="dropdown">
          <button class="editor-btn download-btn" title="Download">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
            </svg>
          </button>
          <div class="dropdown-content">
            <a href="#" class="download-md">Markdown</a>
            <a href="#" class="download-pdf">PDF</a>
          </div>
        </div>
      <!-- END OF BUTTONS -->
    </div>
  </div>

  <div id="canvas-container" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;">
    <!-- Three.js canvas will render here -->
  </div>

  <script>
    const toggleButton = document.getElementById('toggleButton');
    const fileTreeBtn = document.getElementById('fileTreeBtn');
    const fileTree = document.getElementById('fileTree');
    const tests = document.getElementById('tests');
    const peerConnBtn = document.getElementById('peer-btn-connect');
    const modal = document.querySelector('.modal'); // Used by peer-btn-connect
    const leftSlideout = document.getElementById('leftSlideout');
    const chatSlideout = document.getElementById('chatSlideout');
    const homeIcon = document.getElementById('homeIcon');
    const icons = document.querySelectorAll('.sidebar-icon');
    

    // Create a separate modal for homeIcon
    const homeModal = document.createElement('div');
    homeModal.classList.add('modal');
    homeModal.style.display = 'none';
    document.body.appendChild(homeModal);

    let activeIcon = null;

    // leftSlideout.classList.remove('active');

 
fileTreeBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  closeAllModals({leftSlideout: true});

  // Check if slideout is currently active
  const isActive = leftSlideout.classList.contains('active');
  
  // Remove active class from all slideouts first
  leftSlideout.classList.remove('active');
  chatSlideout.classList.remove('active');

  
  // Only add active class if it wasn't active before
  if (!isActive) {
    leftSlideout.classList.add('active');
  }
});
    // Keep the close arrow handler
    const closeArrow = document.querySelector('.close-arrow');
    closeArrow.addEventListener('click', (e) => {
      e.stopPropagation();
      leftSlideout.classList.remove('active');
    });

    // Update closeAllModals function to handle all modals consistently
    function closeAllModals(flags={}) {
      // Hide all slideouts

      if(!flags.leftSlideout){
      leftSlideout.classList.remove('active');
      }
      
      // Hide all standard modals
      hidePeerModal();
      hideHomeModal();
      hideSettingsModal();
      hideSearchModal();
      
      // Hide databases modal with animation
      const databasesModal = document.getElementById('databasesModal');
      if (databasesModal) {
        databasesModal.classList.remove('show');
        const overlay = document.getElementById('overlay');
        overlay.classList.remove('show');
        
        // Wait for animation to complete before hiding
        setTimeout(() => {
          databasesModal.style.display = 'none';
          overlay.style.display = 'none';
        }, 300); // Match your CSS transition duration
      }
    }

    // Functions for peer-btn-connect modal
    function showPeerModal() {
      const iconRect = peerConnBtn.getBoundingClientRect();
      modal.style.top = `${iconRect.top - 15}px`;
      modal.style.display = 'flex';

      modal.offsetHeight; // Trigger reflow

      requestAnimationFrame(() => {
        modal.classList.add('active');
      });

      const arrowOffset = iconRect.height / 2;
      modal.style.setProperty('--arrow-top', `${arrowOffset + 10}px`);
      activeIcon = peerConnBtn;
    }

    function hidePeerModal() {
      modal.style.display = 'none';
      modal.classList.remove('active');
      activeIcon = null;
    }

    // Functions for homeIcon modal
    function showHomeModal() {
      const iconRect = homeIcon.getBoundingClientRect();
      homeModal.style.top = `${iconRect.top - 15}px`;
      homeModal.style.display = 'flex';

      homeModal.innerHTML = getHomeModalContent();
      attachHomeModalListeners();

      homeModal.offsetHeight; // Trigger reflow

      requestAnimationFrame(() => {
        homeModal.classList.add('active');
      });

      const arrowOffset = iconRect.height / 2;
      homeModal.style.setProperty('--arrow-top', `${arrowOffset + 10}px`);
      activeIcon = homeIcon;
    }

    function hideHomeModal() {
      homeModal.style.display = 'none';
      homeModal.classList.remove('active');
      activeIcon = null;
    }

    // Event Listeners for Icons
    peerConnBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      e.preventDefault();

      // Check if modal is currently visible by checking both display and active class
      const isModalVisible = modal.classList.contains('active');
      
      if (!isModalVisible) {
        closeAllModals();
        showPeerModal();
      } else {
        hidePeerModal();
      }

      // Close slideouts if open
      leftSlideout.classList.remove('active');
      chatSlideout.classList.remove('active');
    });

    homeIcon.addEventListener('click', (e) => {
      e.stopPropagation();
      e.preventDefault();

      if (homeModal.style.display === 'none') {
        closeAllModals();
        showHomeModal();
      } else {
        hideHomeModal();
      }
    });

    // Function to get homeModal content
    function getHomeModalContent() {
      return `
       <div class="modal-icons">
      <div class="modal-icon" data-action="visualize-embeddings">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="small-icon">
          <path stroke-linecap="round" stroke-linejoin="round" d="m21 7.5-9-5.25L3 7.5m18 0-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9" />
        </svg>
        <span class="tooltip">Visualized Embeddings in 3D Space</span>
      </div>
      <div class="modal-icon" data-action="cluster-nodes">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="small-icon">
          <path stroke-linecap="round" stroke-linejoin="round" d="m21 7.5-2.25-1.313M21 7.5v2.25m0-2.25-2.25 1.313M3 7.5l2.25-1.313M3 7.5l2.25 1.313M3 7.5v2.25m9 3 2.25-1.313M12 12.75l-2.25-1.313M12 12.75V15m0 6.75 2.25-1.313M12 21.75V19.5m0 2.25-2.25-1.313m0-16.875L12 2.25l2.25 1.313M21 14.25v2.25l-2.25 1.313m-13.5 0L3 16.5v-2.25" />
        </svg>
        <span class="tooltip">Cluster nodes</span>
      </div>
      <div class="modal-icon" data-action="show-network-graph">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="small-icon">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 6.75V15m6-6v8.25m.503 3.498 4.875-2.437c.381-.19.622-.58.622-1.006V4.82c0-.836-.88-1.38-1.628-1.006l-3.869 1.934c-.317.159-.69.159-1.006 0L9.503 3.252a1.125 1.125 0 0 0-1.006 0L3.622 5.689C3.24 5.88 3 6.27 3 6.695V19.18c0 .836.88 1.38 1.628 1.006l3.869-1.934c.317-.159.69-.159 1.006 0l4.994 2.497c.317.158.69.158 1.006 0Z" />
        </svg>
        <span class="tooltip">Show network graph</span>
      </div>
      <div class="modal-icon" data-action="filter-ideas">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="small-icon">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 0 1-.659 1.591l-5.432 5.432a2.25 2.25 0 0 0-.659 1.591v2.927a2.25 2.25 0 0 1-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 0 0-.659-1.591L3.659 7.409A2.25 2.25 0 0 1 3 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0 1 12 3Z" />
        </svg>
        <span class="tooltip">Filter for specific ideas</span>
      </div>
    </div>
      `;
    }

    // Event Handlers for homeModal Icons
    function attachHomeModalListeners() {
      homeModal.querySelectorAll('.modal-icon').forEach(icon => {
        icon.addEventListener('click', (e) => {
          e.stopPropagation();
          const action = e.currentTarget.dataset.action;
          if (action) {
            showSpinner(e.currentTarget);
            console.log("Dispatching", action);
            const event = new CustomEvent('modalAction', { detail: { action } });
            document.dispatchEvent(event);
          }
        });

        const tooltip = icon.querySelector('.tooltip');
        if (tooltip) {
          icon.addEventListener('mouseenter', () => {
            tooltip.style.opacity = '1';
          });
          icon.addEventListener('mouseleave', () => {
            tooltip.style.opacity = '0';
          });
        }
      });
    }

    function showSpinner(iconElement) {
      const svgIcon = iconElement.querySelector('svg');
      const spinner = document.createElement('div');
      spinner.className = 'spinner';
      svgIcon.style.display = 'none';
      iconElement.insertBefore(spinner, svgIcon);

      setTimeout(() => {
        spinner.remove();
        svgIcon.style.display = '';
      }, 4000);
    }

    // Hide modals when clicking outside
    document.addEventListener('click', (e) => {
      if (!modal.contains(e.target) && !e.target.closest('.sidebar-icon')) {
        hidePeerModal();
      }
      if (!homeModal.contains(e.target) && !e.target.closest('.sidebar-icon')) {
        hideHomeModal();
      }
    });

    // Ensure modal events don't propagate
    modal.addEventListener('pointerdown', (e) => e.stopPropagation());
    modal.addEventListener('click', (e) => e.stopPropagation());
    homeModal.addEventListener('pointerdown', (e) => e.stopPropagation());
    homeModal.addEventListener('click', (e) => e.stopPropagation());

    // Tooltips for sidebar icons
    document.querySelectorAll('.sidebar-icon').forEach(icon => {
      icon.addEventListener('mouseenter', () => {
        icon.querySelector('.tooltip').style.opacity = '1';
      });
      icon.addEventListener('mouseleave', () => {
        icon.querySelector('.tooltip').style.opacity = '0';
      });
    });
  </script>


<script>
  // Add settings modal functionality
const settingsIcon = document.getElementById('settingsIcon');
const settingsModal = document.getElementById('settingsModal');

// Create a separate modal for settings
const settingsModalContainer = document.createElement('div');
settingsModalContainer.classList.add('modal');
settingsModalContainer.style.display = 'none';
document.body.appendChild(settingsModalContainer);

function showSettingsModal() {
  closeAllModals(); // Close all other modals first
  
  const iconRect = settingsIcon.getBoundingClientRect();
  settingsModalContainer.style.top = `${iconRect.top - 15}px`;
  settingsModalContainer.style.display = 'flex';
  
  const useCustomProvider = localStorage.getItem('useCustomProvider') === 'true';
  // Updated settings modal content with better design
  settingsModalContainer.innerHTML = `
       <div class="settings-header">
            <div class="model-switch-container">
                <label class="switch">
                    <input type="checkbox" id="providerToggle" ${useCustomProvider ? 'checked' : ''}>
                    <span class="slider round"></span>
                </label>
                <span class="switch-label">Use Custom AI Provider</span>
            </div>
            <select class="modal-select" id="aiModelSelect" ${useCustomProvider ? 'disabled' : ''}>
                <option value="Lumi B">Lumi B</option>
            </select>
        </div>
        <input type="text" class="settings-input" id="aiProviderInput" 
            placeholder="Enter your AI provider" ${!useCustomProvider ? 'disabled' : ''}>
        <input type="text" class="settings-input" id="apiKeyInput" 
            placeholder="Enter your API key" ${!useCustomProvider ? 'disabled' : ''}>
        <button id="saveSettingsButton" class="settings-save-btn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                <polyline points="17 21 17 13 7 13 7 21"/>
                <polyline points="7 3 7 8 15 8"/>
            </svg>
            Save Settings
        </button>
        <div class="settings-pills-container"></div>
        <div class="settings-status"></div>
  `;

  const toggle = settingsModalContainer.querySelector('#providerToggle');
    const inputs = settingsModalContainer.querySelectorAll('.settings-input');
    const modelSelect = settingsModalContainer.querySelector('#aiModelSelect');

    toggle.addEventListener('change', (e) => {
        const useCustom = e.target.checked;
        inputs.forEach(input => input.disabled = !useCustom);
        modelSelect.disabled = useCustom;
        localStorage.setItem('useCustomProvider', useCustom);
    });

      // Trigger pill rendering
      window.eventBus.dispatchEvent(new CustomEvent('renderExistingPills'));


  settingsModalContainer.offsetHeight;
  requestAnimationFrame(() => {
    settingsModalContainer.classList.add('active');
  });

  const arrowOffset = iconRect.height / 2;
  settingsModalContainer.style.setProperty('--arrow-top', `${arrowOffset + 10}px`);
  activeIcon = settingsIcon;

  const saveButton = settingsModalContainer.querySelector('#saveSettingsButton');
  saveButton.addEventListener('click', saveSettings);
}

function hideSettingsModal() {
  settingsModalContainer.style.display = 'none';
  settingsModalContainer.classList.remove('active');
  activeIcon = null;
}

// function saveSettings() {
//   // const provider = document.getElementById('aiProviderInput').value;
//   // const model = document.getElementById('aiModelSelect').value;
//   // const apiKey = document.getElementById('apiKeyInput').value;

//   console.log("NERDDDDD")
//   // Save settings to localStorage or your preferred storage
//   // localStorage.setItem('aiProvider', provider);
//   //       localStorage.setItem('apiKey', apiKey);
//   //       localStorage.setItem('aiModel', model);

//         const url = document.getElementById('aiProviderInput').value.trim();
//         const apiKey = document.getElementById('apiKeyInput').value.trim();

//         // if (url && apiKey) {
//         //   console.log('Dispatching addProvider event');
//         //   window.dispatchEvent(new CustomEvent('addProvider', { detail: { url, apiKey } }));
//         // }

//         console.log("ai provider", url)
//         console.log("api key", apiKey)

//         if (url && apiKey) {
//       console.log('Dispatching addProvider event');
//       window.eventBus.dispatchEvent(new CustomEvent('addProvider', { 
//         detail: { url, apiKey } 
//       }));
//     } else {
//       console.warn('URL or API key is missing');
//     }
        
//         console.log('Settings saved successfully');
//         // hideSettingsModal();
        
//         // Dispatch event for other parts of the application
//         // window.dispatchEvent(new CustomEvent('settingsUpdated', {
//         //   detail: { provider, model }
//         // }));


//         // if (url && apiKey) {
//         //   window.dispatchEvent(new CustomEvent('addProvider', { detail: { url: provider, apiKey } }));
//         // }

//   // hideSettingsModal();
// }
function saveSettings() {
    const url = document.getElementById('aiProviderInput').value.trim();
    const apiKey = document.getElementById('apiKeyInput').value.trim();

    if (url && apiKey) {
        console.log('Dispatching addProvider event');
        
        // Check for existing provider
        const existingProviders = JSON.parse(localStorage.getItem('apiProviders') || '[]');
        const isDuplicate = existingProviders.some(p => 
            p.url.toLowerCase() === url.toLowerCase()
        );

        if (isDuplicate) {
            // Show update message
            const statusDiv = settingsModalContainer.querySelector('.settings-status');
            if (statusDiv) {
                statusDiv.textContent = 'Updating existing provider...';
                statusDiv.style.color = '#2196F3';
                setTimeout(() => {
                    statusDiv.textContent = '';
                }, 2000);
            }
        }

        window.eventBus.dispatchEvent(new CustomEvent('addProvider', { 
            detail: { url, apiKey } 
        }));
        
        // Clear inputs after successful save
        document.getElementById('aiProviderInput').value = '';
        document.getElementById('apiKeyInput').value = '';
        
      
    } else {
        console.warn('URL or API key is missing');
        // Show error message
        const statusDiv = settingsModalContainer.querySelector('.settings-status');
        if (statusDiv) {
            statusDiv.textContent = 'Please enter both URL and API key';
            statusDiv.style.color = '#f44336';
            setTimeout(() => {
                statusDiv.textContent = '';
            }, 2000);
        }
    }
}
// Add click handler for settings icon
settingsIcon.addEventListener('click', (e) => {
  e.stopPropagation();
  e.preventDefault();

  if (settingsModalContainer.style.display === 'none') {
    closeAllModals();
    showSettingsModal();
  } else {
    hideSettingsModal();
  }

  // Close other modals/slideouts
  hidePeerModal();
  hideHomeModal();
  leftSlideout.classList.remove('active');
  chatSlideout.classList.remove('active');
});

// Update document click handler to include settings modal
document.addEventListener('click', (e) => {
  if (!modal.contains(e.target) && 
      !homeModal.contains(e.target) && 
      !settingsModalContainer.contains(e.target) && 
      !e.target.closest('.sidebar-icon')) {
    hidePeerModal();
    hideHomeModal();
    hideSettingsModal();
  }
});
</script>

<script>
  // Add search modal functionality
  const searchBtn = document.getElementById('search-btn');
  const searchModalContainer = document.createElement('div');
  searchModalContainer.classList.add('modal');
  searchModalContainer.style.display = 'none';
  document.body.appendChild(searchModalContainer);

  function showSearchModal() {
    closeAllModals(); // Close all other modals first
    
    const iconRect = searchBtn.getBoundingClientRect();
    searchModalContainer.style.top = `${iconRect.top - 15}px`;
    searchModalContainer.style.display = 'flex';
    
    // Search modal content
    searchModalContainer.innerHTML = `
      <div class="search-header">
        <input type="text" 
               class="search-input" 
               id="searchInput" 
               placeholder="Search your scene..."
               autocomplete="off">
        <div class="search-filters">
          <select class="search-select" id="searchTypeSelect">
            <option value="exact">Exact Match</option>
            <option value="fuzzy">Fuzzy Match</option>
          </select>
        </div>
      </div>
      <div class="search-results" id="searchResults">
        <!-- Results will be populated here -->
      </div>
      <div class="search-status"></div>
    `;

    searchModalContainer.offsetHeight;
    requestAnimationFrame(() => {
      searchModalContainer.classList.add('active');
    });

    const arrowOffset = iconRect.height / 2;
    searchModalContainer.style.setProperty('--arrow-top', `${arrowOffset + 10}px`);
    activeIcon = searchBtn;

    // Add search input handler
    const searchInput = searchModalContainer.querySelector('#searchInput');
    searchInput.addEventListener('input', handleSearch);
    
    // Add search type change handler
    const searchTypeSelect = searchModalContainer.querySelector('#searchTypeSelect');
    searchTypeSelect.addEventListener('change', handleSearch);
  }

  function hideSearchModal() {
    searchModalContainer.style.display = 'none';
    searchModalContainer.classList.remove('active');
    activeIcon = null;
  }

  function handleSearch() {
    const searchInput = document.getElementById('searchInput');
    const searchType = document.getElementById('searchTypeSelect').value;
    const query = searchInput.value.trim();
    const resultsContainer = document.getElementById('searchResults');

    if (query) {
      // Dispatch search event for other parts of the application
      window.eventBus.dispatchEvent(new CustomEvent('search', {
        detail: { 
          query,
          type: searchType
        }
      }));
    } else {
      resultsContainer.innerHTML = '';
    }
  }

  // Add click handler for search button
  searchBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    e.preventDefault();

    if (searchModalContainer.style.display === 'none') {
      closeAllModals();
      showSearchModal();
    } else {
      hideSearchModal();
    }

    // Close other modals/slideouts
    hidePeerModal();
    hideHomeModal();
    hideSettingsModal();
    leftSlideout.classList.remove('active');
    chatSlideout.classList.remove('active');
  });

  // Update document click handler to include search modal
  document.addEventListener('click', (e) => {
    if (!modal.contains(e.target) && 
        !homeModal.contains(e.target) && 
        !settingsModalContainer.contains(e.target) && 
        !searchModalContainer.contains(e.target) && 
        !e.target.closest('.sidebar-icon')) {
      hidePeerModal();
      hideHomeModal();
      hideSettingsModal();
      hideSearchModal();
    }
  });

  // Update closeAllModals function
  function closeAllModals(flags={}) {
    // Hide all slideouts
    if(!flags.leftSlideout) {
      leftSlideout.classList.remove('active');
    }
    
    // Hide all standard modals
    hidePeerModal();
    hideHomeModal();
    hideSettingsModal();
    hideSearchModal();
    
    // Hide databases modal with animation
    const databasesModal = document.getElementById('databasesModal');
    if (databasesModal) {
      databasesModal.classList.remove('show');
      const overlay = document.getElementById('overlay');
      overlay.classList.remove('show');
      
      setTimeout(() => {
        databasesModal.style.display = 'none';
        overlay.style.display = 'none';
      }, 300);
    }
  }
</script>

<script>
  // Get required elements
  const resizeHandle = chatSlideout.querySelector('.resize-handle');
  let isResizing = false;
  let startWidth;
  let startX;

  // Handle resize start
  resizeHandle.addEventListener('mousedown', (e) => {
      if (!chatSlideout.classList.contains('active')) return;
      
      isResizing = true;
      startX = e.pageX;
      startWidth = chatSlideout.offsetWidth;
      
      resizeHandle.classList.add('dragging');
      
      // Add temporary document listeners only while dragging
      document.addEventListener('mousemove', handleMove);
      document.addEventListener('mouseup', handleUp);
      
      e.stopPropagation();
  });

  // Handle dragging
  function handleMove(e) {
      if (!isResizing) return;
      
      const width = startWidth - (e.pageX - startX);
      if (width >= 200 && width <= 800) {
          chatSlideout.style.width = `${width}px`;
      }
  }

  // Handle resize end
  function handleUp() {
      if (!isResizing) return;
      
      isResizing = false;
      resizeHandle.classList.remove('dragging');
      
      // Remove temporary document listeners
      document.removeEventListener('mousemove', handleMove);
      document.removeEventListener('mouseup', handleUp);
  }
</script>

<script type="module" src="/main.js"></script>

</body>

</html>